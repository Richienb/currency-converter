import React, {useState} from 'react';
import {useFormState} from 'react-use-form-state';
import {set, get} from 'idb-keyval';
import money from 'money';

import Input from './input';
import From from './from';
import To from './to';
import Button from './convert-button';
import Reset from './reset-button';

const Converter = () => {
	const [formState, {number, select}] = useFormState();
	const [result, setResult] = useState('');

	const handleSubmit = e => {
		e.preventDefault();

		const {values} = formState;

		get('exchangeRates').then(async val => {
			if (val === undefined) {
				const request = await fetch(`https://api.exchangeratesapi.io/latest?base=${values.from}`);
				const response = await request.json();
				set('exchangeRates', response);

				money.base = response.base;
				money.rates = response.rates;

				const result = money.convert(values.amount, {from: values.from, to: values.to}).toFixed(3);

				setResult(`${values.amount} ${values.from} => ${result} ${values.to}`);
			} else {
				money.base = val.base;
				money.rates = val.rates;

				const result = money.convert(values.amount, {from: values.from, to: values.to}).toFixed(3);

				setResult(`${values.amount} ${values.from} => ${result} ${values.to}`);
			}
		});
	};

	const resetState = () => {
		formState.clear();
		setResult('');
	};

	return (
		<>
			<form onSubmit={handleSubmit}>
				<label>
        Amount
					<br/>
					<Input required {...number('amount')} type="number" min="1" step="any" pattern="[0-9]*" name="amount" placeholder="Amount"/>
				</label>
				<br/>
				<label>
        From
					<br/>
					<From required {...select('from')}>
						<option value="" label="Select"/>
						<option value="EUR">ğŸ‡ªğŸ‡º Euro</option>
						<option value="USD">ğŸ‡ºğŸ‡¸ US dollar</option>
						<option value="JPY">ğŸ‡¯ğŸ‡µ Japanese yen</option>
						<option value="BGN">ğŸ‡§ğŸ‡¬ Bulgarian lev</option>
						<option value="CZK">ğŸ‡¨ğŸ‡¿ Czech koruna</option>
						<option value="DKK">ğŸ‡©ğŸ‡° Danish krone</option>
						<option value="GBP">ğŸ‡¬ğŸ‡§ Pound sterling</option>
						<option value="HUF">ğŸ‡­ğŸ‡º Hungarian forint</option>
						<option value="PLN">ğŸ‡µğŸ‡± Polish zloty</option>
						<option value="RON">ğŸ‡·ğŸ‡´ Romanian leu</option>
						<option value="SEK">ğŸ‡¸ğŸ‡ª Swedish krona</option>
						<option value="CHF">ğŸ‡¨ğŸ‡­ Swiss franc</option>
						<option value="ISK">ğŸ‡®ğŸ‡¸ Icelandic krona</option>
						<option value="NOK">ğŸ‡³ğŸ‡´ Norwegian krone</option>
						<option value="HRK">ğŸ‡­ğŸ‡· Croatian kuna</option>
						<option value="RUB">ğŸ‡·ğŸ‡º Russian rouble</option>
						<option value="TRY">ğŸ‡¹ğŸ‡· Turkish lira</option>
						<option value="AUD">ğŸ‡¦ğŸ‡º Australian dollar</option>
						<option value="BRL">ğŸ‡§ğŸ‡· Brazilian real</option>
						<option value="CAD">ğŸ‡¨ğŸ‡¦ Canadian dollar</option>
						<option value="CNY">ğŸ‡¨ğŸ‡³ Chinese yuan</option>
						<option value="HKD">ğŸ‡­ğŸ‡° Hong Kong dollar</option>
						<option value="IDR">ğŸ‡®ğŸ‡© Indonesian rupiah</option>
						<option value="ILS">ğŸ‡®ğŸ‡± Israeli shekel</option>
						<option value="INR">ğŸ‡®ğŸ‡³ Indian rupee</option>
						<option value="KRW">ğŸ‡°ğŸ‡· South Korean won</option>
						<option value="MXN">ğŸ‡²ğŸ‡½ Mexican peso</option>
						<option value="MYR">ğŸ‡²ğŸ‡¾ Malaysian ringgit</option>
						<option value="NZD">ğŸ‡³ğŸ‡¿ New Zealand dollar</option>
						<option value="PHP">ğŸ‡µğŸ‡­ Philippine peso</option>
						<option value="SGD">ğŸ‡¸ğŸ‡¬ Singapore dollar</option>
						<option value="THB">ğŸ‡¹ğŸ‡­ Thai baht</option>
						<option value="ZAR">ğŸ‡¿ğŸ‡¦ South African rand</option>
					</From>
				</label>
				<br/>
				<label>
        To
					<br/>
					<To required {...select('to')}>
						<option value="" label="Select"/>
						<option value="EUR">ğŸ‡ªğŸ‡º Euro</option>
						<option value="USD">ğŸ‡ºğŸ‡¸ US dollar</option>
						<option value="JPY">ğŸ‡¯ğŸ‡µ Japanese yen</option>
						<option value="BGN">ğŸ‡§ğŸ‡¬ Bulgarian lev</option>
						<option value="CZK">ğŸ‡¨ğŸ‡¿ Czech koruna</option>
						<option value="DKK">ğŸ‡©ğŸ‡° Danish krone</option>
						<option value="GBP">ğŸ‡¬ğŸ‡§ Pound sterling</option>
						<option value="HUF">ğŸ‡­ğŸ‡º Hungarian forint</option>
						<option value="PLN">ğŸ‡µğŸ‡± Polish zloty</option>
						<option value="RON">ğŸ‡·ğŸ‡´ Romanian leu</option>
						<option value="SEK">ğŸ‡¸ğŸ‡ª Swedish krona</option>
						<option value="CHF">ğŸ‡¨ğŸ‡­ Swiss franc</option>
						<option value="ISK">ğŸ‡®ğŸ‡¸ Icelandic krona</option>
						<option value="NOK">ğŸ‡³ğŸ‡´ Norwegian krone</option>
						<option value="HRK">ğŸ‡­ğŸ‡· Croatian kuna</option>
						<option value="RUB">ğŸ‡·ğŸ‡º Russian rouble</option>
						<option value="TRY">ğŸ‡¹ğŸ‡· Turkish lira</option>
						<option value="AUD">ğŸ‡¦ğŸ‡º Australian dollar</option>
						<option value="BRL">ğŸ‡§ğŸ‡· Brazilian real</option>
						<option value="CAD">ğŸ‡¨ğŸ‡¦ Canadian dollar</option>
						<option value="CNY">ğŸ‡¨ğŸ‡³ Chinese yuan</option>
						<option value="HKD">ğŸ‡­ğŸ‡° Hong Kong dollar</option>
						<option value="IDR">ğŸ‡®ğŸ‡© Indonesian rupiah</option>
						<option value="ILS">ğŸ‡®ğŸ‡± Israeli shekel</option>
						<option value="INR">ğŸ‡®ğŸ‡³ Indian rupee</option>
						<option value="KRW">ğŸ‡°ğŸ‡· South Korean won</option>
						<option value="MXN">ğŸ‡²ğŸ‡½ Mexican peso</option>
						<option value="MYR">ğŸ‡²ğŸ‡¾ Malaysian ringgit</option>
						<option value="NZD">ğŸ‡³ğŸ‡¿ New Zealand dollar</option>
						<option value="PHP">ğŸ‡µğŸ‡­ Philippine peso</option>
						<option value="SGD">ğŸ‡¸ğŸ‡¬ Singapore dollar</option>
						<option value="THB">ğŸ‡¹ğŸ‡­ Thai baht</option>
						<option value="ZAR">ğŸ‡¿ğŸ‡¦ South African rand</option>
					</To>
				</label>
				<br/>
				<Button type="submit">
							Convert
				</Button>
				<Reset type="reset" onClick={() => {
					resetState();
				}}
				>
							X
				</Reset>
				<br/>
				<br/>
				{result}
			</form>
		</>
	);
};

export default Converter;
